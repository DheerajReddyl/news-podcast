<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Podcasts</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 2rem;
        }
        .container { max-width: 800px; margin: auto; }
        h1 { color: #ffffff; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .controls {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
        }
        .category-header {
            color: #bb86fc; text-transform: capitalize; margin-top: 1.5rem;
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; user-select: none; border-bottom: 1px solid #333; padding-bottom: 8px;
        }
        .category-header::after { content: '‚ñ∂'; font-size: 0.8em; transition: transform 0.2s ease-in-out; }
        .category-header.expanded::after { transform: rotate(90deg); }
        .podcast-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding-left: 10px; }
        .podcast-item {
            background-color: #1e1e1e; border-left: 4px solid #bb86fc;
            padding: 15px; margin: 1rem 0; border-radius: 4px;
        }
        .podcast-title { font-weight: bold; margin-bottom: 10px; }
        audio { width: 100%; margin-top: 10px; }

        /* --- New Voice Changer Box Styles --- */
        .voice-changer-box {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #333;
            align-items: center;
        }
        .voice-changer-box select {
            padding: 5px;
            background: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .regenerate-button {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .regenerate-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .status-message {
            font-size: 0.8em;
            color: #28a745;
            margin-left: 10px;
        }

        /* --- Transcript Styles (Unchanged) --- */
        .transcript-button { background-color: #333; color: #e0e0e0; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px; font-size: 0.9em; }
        .transcript-container { background-color: #2c2c2c; border-radius: 4px; padding: 15px; margin-top: 10px; line-height: 1.6; max-height: 200px; overflow-y: auto; display: none; }
        .transcript-container span { display: inline; }
        .transcript-container span.highlight { background-color: #bb86fc; color: #121212; border-radius: 3px; padding: 0 2px; font-weight: bold; transition: background-color 0.1s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è Latest AI News Podcasts</h1>

        <div id="podcast-list"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/podcasts')
                .then(response => response.json())
                .then(data => {
                    const podcastListDiv = document.getElementById('podcast-list');
                    if (Object.keys(data).length === 0) {
                        podcastListDiv.innerHTML = '<p>No podcasts generated yet. Run main.py and refresh.</p>';
                        return;
                    }

                    for (const category in data) {
                        const categoryHeader = document.createElement('h2');
                        categoryHeader.className = 'category-header';
                        categoryHeader.textContent = category;
                        const podcastContainer = document.createElement('div');
                        podcastContainer.className = 'podcast-container';

                        categoryHeader.addEventListener('click', () => {
                            categoryHeader.classList.toggle('expanded');
                            if (podcastContainer.style.maxHeight) {
                                podcastContainer.style.maxHeight = null;
                            } else {
                                podcastContainer.style.maxHeight = '10000px';
                            }
                        });

                        podcastListDiv.appendChild(categoryHeader);
                        podcastListDiv.appendChild(podcastContainer);

                        data[category].forEach(podcast => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'podcast-item';
                            itemDiv.innerHTML = `
                                <p class="podcast-title">${podcast.title}</p>
                                <audio controls src="/podcasts/${podcast.category}/${podcast.filename}" id="audio-${podcast.filename}"></audio>
                                <button class="transcript-button">Show Transcript</button>
                                <div class="transcript-container"></div>
                                
                                <div class="voice-changer-box">
                                    <label>Change Voice:</label>
                                    <select class="voice-select" 
                                            data-category="${podcast.category}" 
                                            data-filename="${podcast.filename}">
                                        <option value="female_in" selected>Female (India Accent) - DEFAULT</option>
                                        <option value="random">Random Voice Cycle</option>
                                        <option value="male_us">Male (US Accent)</option>
                                        <option value="female_uk">Female (UK Accent)</option>
                                        <option value="male_in">Male (India Accent)</option>
                                        <option value="female_au">Female (Australia Accent)</option>
                                    </select>
                                    <button class="regenerate-button">Listen Right Away</button>
                                    <span class="status-message"></span>
                                </div>
                            `;
                            podcastContainer.appendChild(itemDiv);
                        });
                    }

                    addTranscriptEventListeners();
                    addRegenerationListeners();

                })
                .catch(error => console.error('Error fetching podcasts:', error));
        });

        // --- NEW REGENERATION LOGIC (Handles the 'Listen Right Away' button) ---
        function addRegenerationListeners() {
            document.querySelectorAll('.podcast-item').forEach(item => {
                const select = item.querySelector('.voice-select');
                const button = item.querySelector('.regenerate-button');
                const audio = item.querySelector('audio');
                const statusSpan = item.querySelector('.status-message');

                button.addEventListener('click', async () => {
                    button.disabled = true;
                    statusSpan.textContent = "Regenerating audio (may take 10-30s)...";
                    statusSpan.style.color = 'yellow';

                    const category = select.dataset.category;
                    const filename = select.dataset.filename;
                    const voiceKey = select.value;

                    try {
                        const response = await fetch('/api/regenerate_podcast', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                category: category,
                                filename: filename,
                                voice_key: voiceKey
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            statusSpan.textContent = "‚úÖ Ready! Playing new version...";
                            statusSpan.style.color = '#28a745';
                            
                            // Force the browser to reload the audio source using a cache-busting timestamp
                            const newSrc = audio.src.split('?')[0] + '?' + new Date().getTime();
                            audio.src = newSrc;
                            
                            // Play the new audio immediately
                            audio.play().catch(e => {
                                console.error("Autoplay failed:", e);
                                statusSpan.textContent = "‚úÖ Ready! Press Play.";
                            });
                        } else {
                            statusSpan.textContent = `‚ùå Error: ${data.error || 'Check server logs.'}`;
                            statusSpan.style.color = 'red';
                        }
                    } catch (error) {
                        statusSpan.textContent = `‚ùå Network Error. Is server.py running?`;
                        statusSpan.style.color = 'red';
                        console.error('Regeneration failed:', error);
                    } finally {
                        button.disabled = false;
                        setTimeout(() => statusSpan.textContent = '', 8000); 
                    }
                });
            });
        }
        // --- End of NEW REGENERATION LOGIC ---

        // (The rest of the transcript logic remains the same)
        function addTranscriptEventListeners() {
            document.querySelectorAll('.podcast-item').forEach(item => {
                const button = item.querySelector('.transcript-button');
                const audio = item.querySelector('audio');
                const transcriptContainer = item.querySelector('.transcript-container');
                let words = []; 
                let lastHighlightedIndex = -1;

                button.addEventListener('click', async () => {
                    if (transcriptContainer.style.display === 'block') {
                        transcriptContainer.style.display = 'none';
                        button.textContent = 'Show Transcript';
                        return;
                    }
                    
                    const src = audio.getAttribute('src');
                    const parts = src.split('/');
                    const category = parts[2];
                    const filename = parts[3];

                    try {
                        transcriptContainer.innerHTML = 'Loading transcript...';
                        const response = await fetch(`/api/transcript/${category}/${filename}`);
                        const data = await response.json();

                        if (data.transcript) {
                            const rawWords = data.transcript.match(/\S+/g) || [];

                            words = rawWords.map(word => {
                                const span = document.createElement('span');
                                span.textContent = word + ' ';
                                return span;
                            });
                            
                            transcriptContainer.innerHTML = '';
                            words.forEach(span => transcriptContainer.appendChild(span));
                            
                            transcriptContainer.style.display = 'block';
                            button.textContent = 'Hide Transcript';
                        } else {
                             transcriptContainer.innerHTML = data.error || 'Could not load transcript.';
                        }

                    } catch (error) {
                        transcriptContainer.innerHTML = 'Network error loading transcript.';
                        console.error('Error fetching transcript:', error);
                    }
                });

                audio.addEventListener('timeupdate', () => {
                    if (words.length === 0 || !audio.duration || transcriptContainer.style.display !== 'block') return;

                    const progress = audio.currentTime / audio.duration;
                    const currentIndex = Math.min(Math.floor(progress * words.length), words.length - 1);
                    
                    if (currentIndex !== lastHighlightedIndex) {
                        
                        if (lastHighlightedIndex >= 0 && words[lastHighlightedIndex]) {
                            words[lastHighlightedIndex].classList.remove('highlight');
                        }
                        
                        if (currentIndex >= 0 && words[currentIndex]) {
                            words[currentIndex].classList.add('highlight');
                            
                            const containerRect = transcriptContainer.getBoundingClientRect();
                            const wordRect = words[currentIndex].getBoundingClientRect();

                            if (wordRect.top < containerRect.top || wordRect.bottom > containerRect.bottom) {
                                words[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        }
                        lastHighlightedIndex = currentIndex;
                    }
                });
            });
        }
    </script>
</body>
</html>